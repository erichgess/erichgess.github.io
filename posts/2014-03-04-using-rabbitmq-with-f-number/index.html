<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Using RabbitMQ with F# | Elegant Architecture</title>
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Over the last few years, one of the topics on which I have done much of my work has been distributed computing using message queues. Recently, I&rsquo;ve been playing around with RabbitMQ, not for any reason other than that I wanted a simple, easy to setup, and easy to use messaging framework, which I could use for little experiments at home.
I&rsquo;m not going to talk much about using RabbitMQ. What I am going to talk about is one of the many ways in which F# makes programming just an absolute blast.">
<meta name=generator content="Hugo 0.87.0">
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel=stylesheet href=/ananke/css/main.min.css>
<meta property="og:title" content="Using RabbitMQ with F#">
<meta property="og:description" content="Over the last few years, one of the topics on which I have done much of my work has been distributed computing using message queues. Recently, I&rsquo;ve been playing around with RabbitMQ, not for any reason other than that I wanted a simple, easy to setup, and easy to use messaging framework, which I could use for little experiments at home.
I&rsquo;m not going to talk much about using RabbitMQ. What I am going to talk about is one of the many ways in which F# makes programming just an absolute blast.">
<meta property="og:type" content="article">
<meta property="og:url" content="http://example.org/posts/2014-03-04-using-rabbitmq-with-f-number/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2014-03-04T19:56:20+00:00">
<meta property="article:modified_time" content="2014-03-04T19:56:20+00:00">
<meta itemprop=name content="Using RabbitMQ with F#">
<meta itemprop=description content="Over the last few years, one of the topics on which I have done much of my work has been distributed computing using message queues. Recently, I&rsquo;ve been playing around with RabbitMQ, not for any reason other than that I wanted a simple, easy to setup, and easy to use messaging framework, which I could use for little experiments at home.
I&rsquo;m not going to talk much about using RabbitMQ. What I am going to talk about is one of the many ways in which F# makes programming just an absolute blast."><meta itemprop=datePublished content="2014-03-04T19:56:20+00:00">
<meta itemprop=dateModified content="2014-03-04T19:56:20+00:00">
<meta itemprop=wordCount content="662">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Using RabbitMQ with F#">
<meta name=twitter:description content="Over the last few years, one of the topics on which I have done much of my work has been distributed computing using message queues. Recently, I&rsquo;ve been playing around with RabbitMQ, not for any reason other than that I wanted a simple, easy to setup, and easy to use messaging framework, which I could use for little experiments at home.
I&rsquo;m not going to talk much about using RabbitMQ. What I am going to talk about is one of the many ways in which F# makes programming just an absolute blast.">
</head>
<body class="ma0 avenir bg-near-white">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a href=/ class="f3 fw2 hover-white no-underline white-90 dib">
Elegant Architecture
</a>
<div class="flex-l items-center">
</div>
</div>
</nav>
</div>
</header>
<main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside class="instapaper_ignoref b helvetica tracked">
POSTS
</aside>
<div id=sharing class=mt3>
<a href="https://www.facebook.com/sharer.php?u=http://example.org/posts/2014-03-04-using-rabbitmq-with-f-number/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a href="https://twitter.com/share?url=http://example.org/posts/2014-03-04-using-rabbitmq-with-f-number/&text=Using%20RabbitMQ%20with%20F#" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=http://example.org/posts/2014-03-04-using-rabbitmq-with-f-number/&title=Using%20RabbitMQ%20with%20F#" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div>
<h1 class="f1 athelas mt3 mb1">Using RabbitMQ with F#</h1>
<time class="f6 mv4 dib tracked" datetime=2014-03-04T19:56:20Z>March 4, 2014</time>
</header>
<div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Over the last few years, one of the topics on which I have done much of my work has been distributed computing using message queues. Recently, I&rsquo;ve been playing around with RabbitMQ, not for any reason other than that I wanted a simple, easy to setup, and easy to use messaging framework, which I could use for little experiments at home.</p>
<p>I&rsquo;m not going to talk much about using RabbitMQ. What I am going to talk about is one of the many ways in which F# makes programming just an absolute blast.</p>
<p>Outside of work, most of my programming has been with F# (with a tiny bit of Clojure). Naturally, I&rsquo;ve done some experiments with using F# and RabbitMQ. I&rsquo;ll cover that, but that&rsquo;s not really what this post is about.</p>
<p>My first attempt at this was to just follow the basic C# tutorial from <a href=http://www.rabbitmq.com>www.rabbitmq.com</a>, twisting it here and there for F#. The tutorial you build a simple sender/receiver system: one app sends messages to another app, which prints them to the console. Which got me with some good workable boring code:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> factory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionFactory<span style=color:#f92672>(</span>HostName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>use</span> connection <span style=color:#f92672>=</span> factory<span style=color:#f92672>.</span>CreateConnection()
<span style=color:#66d9ef>use</span> channel <span style=color:#f92672>=</span> connection<span style=color:#f92672>.</span>CreateModel()

channel<span style=color:#f92672>.</span>QueueDeclare<span style=color:#f92672>(</span> <span style=color:#e6db74>&#34;hello&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>)</span>
<span style=color:#66d9ef>let</span> consumer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueueingBasicConsumer<span style=color:#f92672>(</span>channel<span style=color:#f92672>)</span>
channel<span style=color:#f92672>.</span>BasicConsume<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hello&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> consumer<span style=color:#f92672>)</span>

<span style=color:#66d9ef>while</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>do</span>
    <span style=color:#66d9ef>let</span> ea <span style=color:#f92672>=</span> consumer<span style=color:#f92672>.</span>Queue<span style=color:#f92672>.</span>Dequeue() <span style=color:#f92672>:&gt;</span> BasicDeliverEventArgs
    <span style=color:#66d9ef>let</span> body <span style=color:#f92672>=</span> ea<span style=color:#f92672>.</span>Body
    <span style=color:#66d9ef>let</span> message <span style=color:#f92672>=</span> Encoding.UTF8.GetString<span style=color:#f92672>(</span>body<span style=color:#f92672>)</span>
    printfn <span style=color:#e6db74>&#34;%s&#34;</span> message
</code></pre></div><p>This will do its job. Listening on the queue and writing the messages as they come in. It&rsquo;s not spectaculor and it doesn&rsquo;t use any of the Consumer class framework which comes with RabbitMQ. But again, this post isn&rsquo;t about using RabbitMQ, it&rsquo;s about using <em>sequence expressions</em>.</p>
<p>The Sequence Expression is a fun little construct in F# that lets you write programmatic enumerables. For example, I want an enumerable with the numbers from 1 to 100, I would just write</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> example <span style=color:#f92672>=</span> seq<span style=color:#f92672>{</span> 1 <span style=color:#f92672>..</span> 100 <span style=color:#f92672>}</span>
</code></pre></div><p>Or, what if I want a sequence of data, where everytime I ask for an element it gives me the current time:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> example2 <span style=color:#f92672>=</span> seq <span style=color:#f92672>{</span> 
						<span style=color:#66d9ef>while</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>do</span>
							<span style=color:#66d9ef>yield</span> DateTime.Now
				   <span style=color:#f92672>}</span>
</code></pre></div><p>The sequence expression got me to thinking about trying that out with the message queues. So, I changed my receiver code to look like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> factory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConnectionFactory<span style=color:#f92672>(</span>HostName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>use</span> connection <span style=color:#f92672>=</span> factory<span style=color:#f92672>.</span>CreateConnection()
<span style=color:#66d9ef>use</span> channel <span style=color:#f92672>=</span> connection<span style=color:#f92672>.</span>CreateModel()

channel<span style=color:#f92672>.</span>QueueDeclare<span style=color:#f92672>(</span> <span style=color:#e6db74>&#34;hello&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>)</span>
<span style=color:#66d9ef>let</span> consumer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueueingBasicConsumer<span style=color:#f92672>(</span>channel<span style=color:#f92672>)</span>
channel<span style=color:#f92672>.</span>BasicConsume<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hello&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> consumer<span style=color:#f92672>)</span>

<span style=color:#75715e>// I wrap the queue in a sequence expression
</span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> queue <span style=color:#f92672>=</span> seq<span style=color:#f92672>{</span>
                <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>do</span>
                    <span style=color:#66d9ef>let</span> ea <span style=color:#f92672>=</span> consumer<span style=color:#f92672>.</span>Queue<span style=color:#f92672>.</span>Dequeue() <span style=color:#f92672>:&gt;</span> BasicDeliverEventArgs
                    <span style=color:#66d9ef>let</span> body <span style=color:#f92672>=</span> ea<span style=color:#f92672>.</span>Body
                    <span style=color:#66d9ef>let</span> message <span style=color:#f92672>=</span> Encoding.UTF8.GetString<span style=color:#f92672>(</span>body<span style=color:#f92672>)</span>
                    <span style=color:#66d9ef>yield</span> message
            <span style=color:#f92672>}</span>
</code></pre></div><p>This creates an enumerable data structure called <code>queue</code>. And this is where things get awesome, because I can now write <em>queries</em> to my queue of messages, exactly as I would to a database or list:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> qQuery <span style=color:#f92672>=</span> query<span style=color:#f92672>{</span>
                <span style=color:#66d9ef>for</span> message <span style=color:#66d9ef>in</span> queue <span style=color:#66d9ef>do</span>
                <span style=color:#66d9ef>select</span> i<span style=color:#f92672>.</span>ToUpper()
             <span style=color:#f92672>}</span>
qQuery <span style=color:#f92672>|&gt;</span> Seq.iter <span style=color:#f92672>(</span>printfn <span style=color:#e6db74>&#34;%d&#34;</span><span style=color:#f92672>)</span>
</code></pre></div><p>This query will select each message from the queue and convert it to all capital letters. The Seq.iter will then pull each message from the query result and print it to the screen. Do note that the <code>seq{...}</code> I bound to <code>queue</code> is an infinite loop, so <code>qQuery |> Seq.iter (printfn "%d")</code> will run forever, printing out each message as it arrives in the queue.</p>
<p>If you take a look at the <a href=http://msdn.microsoft.com/en-us/library/hh225374.aspx>MSDN</a> article on F#&rsquo;s Query Expressions, you&rsquo;ll see that there is a lot that can be done. For example, if we had two different queues:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fsharp data-lang=fsharp><span style=color:#66d9ef>let</span> doubleQuery <span style=color:#f92672>=</span> query<span style=color:#f92672>{</span>
                    <span style=color:#66d9ef>for</span> m1 <span style=color:#66d9ef>in</span> queue <span style=color:#66d9ef>do</span>
                    join m2 <span style=color:#66d9ef>in</span> queue2 on
                        <span style=color:#f92672>(</span>m1 <span style=color:#f92672>=</span> m2<span style=color:#f92672>)</span>
                    <span style=color:#66d9ef>select</span> <span style=color:#f92672>(</span>m1<span style=color:#f92672>,</span> m2<span style=color:#f92672>)</span>
                  <span style=color:#f92672>}</span>
</code></pre></div><p>Or maybe even a join between the message queue and a database query.</p>
<p>The long and short of all this is that I keep falling more in love with F#. I get to spend so much time not writing boilerplate code and squiggly braces and so much time just doing.</p>
<ul class=pa0>
</ul>
<div class="mt6 instapaper_ignoref">
</div>
</div>
<aside class="w-30-l mt6-l">
</aside>
</article>
</main>
<footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=http://example.org/>
&copy; Elegant Architecture 2021
</a>
<div>
</div>
</div>
</footer>
</body>
</html>