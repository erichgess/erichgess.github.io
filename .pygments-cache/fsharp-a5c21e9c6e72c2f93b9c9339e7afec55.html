<div class="highlight"><pre><span class="k">let</span> <span class="k">rec</span> <span class="n">balance</span> <span class="n">comparer</span> <span class="n">t1</span> <span class="n">k</span> <span class="n">t2</span> <span class="o">=</span>
    <span class="c1">// Given t1 &amp;lt; k &amp;lt; t2 where t1 and t2 are “balanced”,</span>
    <span class="c1">// return a balanced tree for &amp;lt;t1,k,t2&amp;gt;.</span>
    <span class="c1">// Recall: balance means subtrees heights differ by at most “tolerance”</span>
    <span class="k">match</span> <span class="n">t1</span><span class="o">,</span><span class="n">t2</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">SetEmpty</span><span class="o">,</span><span class="n">t2</span>  <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">add</span> <span class="n">comparer</span> <span class="n">k</span> <span class="n">t2</span> <span class="c1">// drop t1 = empty </span>
    <span class="o">|</span> <span class="n">t1</span><span class="o">,</span><span class="nc">SetEmpty</span>  <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">add</span> <span class="n">comparer</span> <span class="n">k</span> <span class="n">t1</span> <span class="c1">// drop t2 = empty </span>
    <span class="o">|</span> <span class="nc">SetOne</span> <span class="n">k1</span><span class="o">,</span><span class="n">t2</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">add</span> <span class="n">comparer</span> <span class="n">k</span> <span class="o">(</span><span class="n">add</span> <span class="n">comparer</span> <span class="n">k1</span> <span class="n">t2</span><span class="o">)</span>
    <span class="o">|</span> <span class="n">t1</span><span class="o">,</span><span class="nc">SetOne</span> <span class="n">k2</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">add</span> <span class="n">comparer</span> <span class="n">k</span> <span class="o">(</span><span class="n">add</span> <span class="n">comparer</span> <span class="n">k2</span> <span class="n">t1</span><span class="o">)</span>
    <span class="o">|</span> <span class="nc">SetNode</span><span class="o">(</span><span class="n">k1</span><span class="o">,</span><span class="n">t11</span><span class="o">,</span><span class="n">t12</span><span class="o">,</span><span class="n">h1</span><span class="o">),</span><span class="nc">SetNode</span><span class="o">(</span><span class="n">k2</span><span class="o">,</span><span class="n">t21</span><span class="o">,</span><span class="n">t22</span><span class="o">,</span><span class="n">h2</span><span class="o">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
        <span class="c1">// Have:  (t11 &amp;lt; k1 &amp;lt; t12) &amp;lt; k &amp;lt; (t21 &amp;lt; k2 &amp;lt; t22)</span>
        <span class="c1">// Either (a) h1,h2 differ by at most 2 - no rebalance needed.</span>
        <span class="c1">//        (b) h1 too small, i.e. h1+2 &amp;lt; h2</span>
        <span class="c1">//        (c) h2 too small, i.e. h2+2 &amp;lt; h1 </span>
        <span class="k">if</span>   <span class="n">h1</span><span class="o">+</span><span class="n">tolerance</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">h2</span> <span class="k">then</span>
            <span class="c1">// case: b, h1 too small </span>
            <span class="c1">// push t1 into low side of t2, may increase height by 1 so rebalance </span>
            <span class="n">rebalance</span> <span class="o">(</span><span class="n">balance</span> <span class="n">comparer</span> <span class="n">t1</span> <span class="n">k</span> <span class="n">t21</span><span class="o">)</span> <span class="n">k2</span> <span class="n">t22</span>
        <span class="k">elif</span> <span class="n">h2</span><span class="o">+</span><span class="n">tolerance</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">h1</span> <span class="k">then</span>
            <span class="c1">// case: c, h2 too small </span>
            <span class="c1">// push t2 into high side of t1, may increase height by 1 so rebalance </span>
            <span class="n">rebalance</span> <span class="n">t11</span> <span class="n">k1</span> <span class="o">(</span><span class="n">balance</span> <span class="n">comparer</span> <span class="n">t12</span> <span class="n">k</span> <span class="n">t2</span><span class="o">)</span>
        <span class="k">else</span>
            <span class="c1">// case: a, h1 and h2 meet balance requirement </span>
            <span class="n">mk</span> <span class="n">t1</span> <span class="n">k</span> <span class="n">t2</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">let</span> <span class="k">rec</span> <span class="n">split</span> <span class="o">(</span><span class="n">comparer</span> <span class="o">:</span> <span class="nc">IComparer</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="err">’</span><span class="nc">T</span><span class="o">&amp;</span><span class="n">gt</span><span class="o">;)</span> <span class="n">pivot</span> <span class="n">t</span> <span class="o">=</span>
    <span class="c1">// Given a pivot and a set t</span>
    <span class="c1">// Return { x in t s.t. x &amp;lt; pivot }, pivot in t? , { x in t s.t. x &amp;gt; pivot } </span>
    <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">SetNode</span><span class="o">(</span><span class="n">k1</span><span class="o">,</span><span class="n">t11</span><span class="o">,</span><span class="n">t12</span><span class="o">,_)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">comparer</span><span class="o">.</span><span class="nc">Compare</span><span class="o">(</span><span class="n">pivot</span><span class="o">,</span><span class="n">k1</span><span class="o">)</span>
        <span class="k">if</span>   <span class="n">c</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="mi">0</span> <span class="k">then</span> <span class="c1">// pivot t1 </span>
            <span class="k">let</span> <span class="n">t11Lo</span><span class="o">,</span><span class="n">havePivot</span><span class="o">,</span><span class="n">t11Hi</span> <span class="o">=</span> <span class="n">split</span> <span class="n">comparer</span> <span class="n">pivot</span> <span class="n">t11</span>
            <span class="n">t11Lo</span><span class="o">,</span><span class="n">havePivot</span><span class="o">,</span><span class="n">balance</span> <span class="n">comparer</span> <span class="n">t11Hi</span> <span class="n">k1</span> <span class="n">t12</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="c1">// pivot is k1 </span>
            <span class="n">t11</span><span class="o">,</span><span class="bp">true</span><span class="o">,</span><span class="n">t12</span>
        <span class="k">else</span>            <span class="c1">// pivot t2 </span>
            <span class="k">let</span> <span class="n">t12Lo</span><span class="o">,</span><span class="n">havePivot</span><span class="o">,</span><span class="n">t12Hi</span> <span class="o">=</span> <span class="n">split</span> <span class="n">comparer</span> <span class="n">pivot</span> <span class="n">t12</span>
            <span class="n">balance</span> <span class="n">comparer</span> <span class="n">t11</span> <span class="n">k1</span> <span class="n">t12Lo</span><span class="o">,</span><span class="n">havePivot</span><span class="o">,</span><span class="n">t12Hi</span>
    <span class="o">|</span> <span class="nc">SetOne</span> <span class="n">k1</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">comparer</span><span class="o">.</span><span class="nc">Compare</span><span class="o">(</span><span class="n">k1</span><span class="o">,</span><span class="n">pivot</span><span class="o">)</span>
        <span class="k">if</span>   <span class="n">c</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">t</span>       <span class="o">,</span><span class="bp">false</span><span class="o">,</span><span class="nc">SetEmpty</span> <span class="c1">// singleton under pivot </span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="nc">SetEmpty</span><span class="o">,</span><span class="bp">true</span> <span class="o">,</span><span class="nc">SetEmpty</span> <span class="c1">// singleton is    pivot </span>
        <span class="k">else</span>            <span class="nc">SetEmpty</span><span class="o">,</span><span class="bp">false</span><span class="o">,</span><span class="n">t</span>        <span class="c1">// singleton over  pivot </span>
    <span class="o">|</span> <span class="nc">SetEmpty</span>  <span class="o">-&amp;</span><span class="n">gt</span><span class="o">;</span> 
        <span class="nc">SetEmpty</span><span class="o">,</span><span class="bp">false</span><span class="o">,</span><span class="nc">SetEmpty</span>
</pre></div>