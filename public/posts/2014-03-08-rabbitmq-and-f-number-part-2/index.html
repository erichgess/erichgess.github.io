<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  
  <title>RabbitMQ and F# - Part 2 | Erich&#39;s Site</title>
  <meta name="viewport" content="width=device-width,minimum-scale=1">
  <meta name="description"
    content="Notes about RabbitMQ: - You should have one connection per application and one channel per thread (http://stackoverflow.com/a/10501593)
I was able to build and run my sender and receiver, both using my client.
However, something odd happened. The receiver was only printing out every other message which the Sender sent.
Here&rsquo;s the secret of what&rsquo;s happening:
OH SNAP! There are two consumers on the queue and RabbitMQ is splitting the messages evenly between the two consumers.">

  

  <meta name="generator" content="Hugo 0.87.0" />
  
  
  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
  

  
<link rel="stylesheet" href="/ananke/css/main.min.css" >




  
  

  

  

  <meta property="og:title" content="RabbitMQ and F# - Part 2" />
<meta property="og:description" content="Notes about RabbitMQ: - You should have one connection per application and one channel per thread (http://stackoverflow.com/a/10501593)
I was able to build and run my sender and receiver, both using my client.
However, something odd happened. The receiver was only printing out every other message which the Sender sent.
Here&rsquo;s the secret of what&rsquo;s happening:
OH SNAP! There are two consumers on the queue and RabbitMQ is splitting the messages evenly between the two consumers." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/2014-03-08-rabbitmq-and-f-number-part-2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2014-03-08T21:15:36+00:00" />
<meta property="article:modified_time" content="2014-03-08T21:15:36+00:00" />

<meta itemprop="name" content="RabbitMQ and F# - Part 2">
<meta itemprop="description" content="Notes about RabbitMQ: - You should have one connection per application and one channel per thread (http://stackoverflow.com/a/10501593)
I was able to build and run my sender and receiver, both using my client.
However, something odd happened. The receiver was only printing out every other message which the Sender sent.
Here&rsquo;s the secret of what&rsquo;s happening:
OH SNAP! There are two consumers on the queue and RabbitMQ is splitting the messages evenly between the two consumers."><meta itemprop="datePublished" content="2014-03-08T21:15:36+00:00" />
<meta itemprop="dateModified" content="2014-03-08T21:15:36+00:00" />
<meta itemprop="wordCount" content="641">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="RabbitMQ and F# - Part 2"/>
<meta name="twitter:description" content="Notes about RabbitMQ: - You should have one connection per application and one channel per thread (http://stackoverflow.com/a/10501593)
I was able to build and run my sender and receiver, both using my client.
However, something odd happened. The receiver was only printing out every other message which the Sender sent.
Here&rsquo;s the secret of what&rsquo;s happening:
OH SNAP! There are two consumers on the queue and RabbitMQ is splitting the messages evenly between the two consumers."/>

  
</head>

<body class="ma0 avenir bg-near-white">

  
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Erich&#39;s Site
      
    </a>
    <div class="flex-l items-center">
      

      
      















    </div>
  </div>
</nav>

    </div>
  </header>



  <main class="pb7" role="main">
    
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=http://example.org/posts/2014-03-08-rabbitmq-and-f-number-part-2/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=http://example.org/posts/2014-03-08-rabbitmq-and-f-number-part-2/&amp;text=RabbitMQ%20and%20F#%20-%20Part%202" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://example.org/posts/2014-03-08-rabbitmq-and-f-number-part-2/&amp;title=RabbitMQ%20and%20F#%20-%20Part%202" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">RabbitMQ and F# - Part 2</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2014-03-08T21:15:36Z">March 8, 2014</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Notes about RabbitMQ:
- You should have one connection per application and one channel per thread (<a href="http://stackoverflow.com/a/10501593">http://stackoverflow.com/a/10501593</a>)</p>
<p>I was able to build and run my sender and receiver, both using my client.</p>
<p>However, something odd happened.  The receiver was only printing out every other message which the Sender sent.</p>
<!-- raw HTML omitted -->
<p><img src="/images/rabbitmq_and_fsharp/missing_messages.png" alt="Missing Messages"></p>
<p>Here&rsquo;s the secret of what&rsquo;s happening:</p>
<p><img src="/images/rabbitmq_and_fsharp/too_many_consumers.png" alt="Too Many Consumers"></p>
<p>OH SNAP!  There are two consumers on the queue and RabbitMQ is splitting the messages evenly between the two consumers.</p>
<p>My suspicion is that the Sender is also opening up a consumer.  I can verify this easily by starting only the Sender and looking at the RaabbitMQ console:</p>
<p><img src="/images/rabbitmq_and_fsharp/too_many_consumers_2.png" alt="Too Many Consumers"></p>
<p>Sure enough, there&rsquo;s one consumer!  So the Sender is also opening up a consumer and reading messages from the queue.</p>
<p>The culprit is almost certainly this bit of code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> consumer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> QueueingBasicConsumer<span style="color:#f92672">(</span>channel<span style="color:#f92672">)</span> 
channel<span style="color:#f92672">.</span>BasicConsume<span style="color:#f92672">(</span>queueName<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> consumer<span style="color:#f92672">)</span> <span style="color:#f92672">|&gt;</span> ignore

<span style="color:#f92672">{</span>Name <span style="color:#f92672">=</span> queueName<span style="color:#f92672">;</span> 
Read <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> () <span style="color:#f92672">-&gt;</span> readFromQueue consumer queueName<span style="color:#f92672">);</span> 
Publish <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>publishToQueue channel queueName<span style="color:#f92672">)}</span>
</code></pre></div><p>I create a consumer and attach it to the queue every time a request is made to open a queue.  My assumption had been that a message would only be read from the queue when <code>consumer.Queue.Dequeue()</code> was called.  This is a fairly obvious error, in hindsight.  Reading the documentation further, I see that the consumer sets up a subscription to a queue and messages are automatically read; making this a push pattern.  To do a pull pattern, I would just use BasicGet on the queue.</p>
<p>A basic get example, in C#:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">BasicGetResult result = channel.BasicGet(queueName, noAck);
</code></pre></div><p>I do want to have subscriptions and for this to be useful in my future projects.  However, for now my goal is to get a simple functioning library.  So I will switch my code over to use the basic get.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> connectToQueue connection <span style="color:#f92672">(</span>channel<span style="color:#f92672">:</span>IModel<span style="color:#f92672">)</span> queueName <span style="color:#f92672">=</span>           
    declareQueue channel queueName <span style="color:#f92672">|&gt;</span> ignore

    <span style="color:#f92672">{</span>Name <span style="color:#f92672">=</span> queueName<span style="color:#f92672">;</span> 
    Read <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> () <span style="color:#f92672">-&gt;</span> 
                    <span style="color:#66d9ef">let</span> ea <span style="color:#f92672">=</span> channel<span style="color:#f92672">.</span>BasicGet<span style="color:#f92672">(</span>queueName<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
                    <span style="color:#66d9ef">if</span> ea <span style="color:#f92672">&lt;&gt;</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">then</span>
                        <span style="color:#66d9ef">let</span> body <span style="color:#f92672">=</span> ea<span style="color:#f92672">.</span>Body
                        <span style="color:#66d9ef">let</span> message <span style="color:#f92672">=</span> Encoding.UTF8.GetString<span style="color:#f92672">(</span>body<span style="color:#f92672">)</span>
                        message
                    <span style="color:#66d9ef">else</span>
                        <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span> 
    Publish <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>publishToQueue channel queueName<span style="color:#f92672">)}</span>
</code></pre></div><p>The Read function now does a BasicGet and decodes the message.</p>
<p>The result:</p>
<p><img src="/images/rabbitmq_and_fsharp/right_number_consumers.png" alt="Right Number Of Consumers"></p>
<p>No more extra consumer!</p>
<p>I really don’t like the part where I return &quot;&quot; if there is nothing in the queue.  There&rsquo;s already a great way of handling that in F#.  So I&rsquo;ll change the Read function to return a string option, which will change my code to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp">Read <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> () <span style="color:#f92672">-&gt;</span> 
                <span style="color:#66d9ef">let</span> ea <span style="color:#f92672">=</span> channel<span style="color:#f92672">.</span>BasicGet<span style="color:#f92672">(</span>queueName<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
                <span style="color:#66d9ef">if</span> ea <span style="color:#f92672">&lt;&gt;</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">then</span>
                    <span style="color:#66d9ef">let</span> body <span style="color:#f92672">=</span> ea<span style="color:#f92672">.</span>Body
                    <span style="color:#66d9ef">let</span> message <span style="color:#f92672">=</span> Encoding.UTF8.GetString<span style="color:#f92672">(</span>body<span style="color:#f92672">)</span>
                    Some message
                <span style="color:#66d9ef">else</span>
                    None<span style="color:#f92672">);</span>
</code></pre></div><p>This is good, because it will force developers using this function to deal with both the case where a message is on the queue and the case where there is no message on the queue.</p>
<p>Here&rsquo;s the current complete code for my simple F# library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">namespace</span> RabbitMQ.FSharp

<span style="color:#66d9ef">open</span> RabbitMQ.Client
<span style="color:#66d9ef">open</span> RabbitMQ.Client.Events
<span style="color:#66d9ef">open</span> System.Text

<span style="color:#66d9ef">module</span> Client <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Queue</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> Name<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">;</span> Read<span style="color:#f92672">:</span> <span style="color:#66d9ef">unit</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">;</span> Publish<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">unit</span> <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">let</span> openConnection address <span style="color:#f92672">=</span> 
        <span style="color:#66d9ef">let</span> factory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConnectionFactory<span style="color:#f92672">(</span>HostName <span style="color:#f92672">=</span> address<span style="color:#f92672">)</span>
        factory<span style="color:#f92672">.</span>CreateConnection()

    <span style="color:#75715e">// I need to declare the type for connection because F# can&#39;t infer types on classes
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> openChannel <span style="color:#f92672">(</span>connection<span style="color:#f92672">:</span>IConnection<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> connection<span style="color:#f92672">.</span>CreateModel()

    <span style="color:#66d9ef">let</span> declareQueue <span style="color:#f92672">(</span>channel<span style="color:#f92672">:</span>IModel<span style="color:#f92672">)</span> queueName <span style="color:#f92672">=</span> channel<span style="color:#f92672">.</span>QueueDeclare<span style="color:#f92672">(</span> queueName<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">)</span>

    <span style="color:#66d9ef">let</span> readFromQueue <span style="color:#f92672">(</span>consumer<span style="color:#f92672">:</span>QueueingBasicConsumer<span style="color:#f92672">)</span> queueName <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">let</span> ea <span style="color:#f92672">=</span> consumer<span style="color:#f92672">.</span>Queue<span style="color:#f92672">.</span>Dequeue()
        <span style="color:#66d9ef">let</span> body <span style="color:#f92672">=</span> ea<span style="color:#f92672">.</span>Body
        <span style="color:#66d9ef">let</span> message <span style="color:#f92672">=</span> Encoding.UTF8.GetString<span style="color:#f92672">(</span>body<span style="color:#f92672">)</span>
        message

    <span style="color:#66d9ef">let</span> publishToQueue <span style="color:#f92672">(</span>channel<span style="color:#f92672">:</span>IModel<span style="color:#f92672">)</span> queueName <span style="color:#f92672">(</span>message<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
        <span style="color:#66d9ef">let</span> body <span style="color:#f92672">=</span> Encoding.UTF8.GetBytes<span style="color:#f92672">(</span>message<span style="color:#f92672">)</span>
        channel<span style="color:#f92672">.</span>BasicPublish<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> queueName<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> body<span style="color:#f92672">)</span>

    <span style="color:#75715e">// I don&#39;t have to declare the type of connection, because F# can infer the type from my call to openChannel
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> connectToQueue connection <span style="color:#f92672">(</span>channel<span style="color:#f92672">:</span>IModel<span style="color:#f92672">)</span> queueName <span style="color:#f92672">=</span>            
        declareQueue channel queueName <span style="color:#f92672">|&gt;</span> ignore

        <span style="color:#f92672">{</span>Name <span style="color:#f92672">=</span> queueName<span style="color:#f92672">;</span> 
        Read <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> () <span style="color:#f92672">-&gt;</span> 
                        <span style="color:#66d9ef">let</span> ea <span style="color:#f92672">=</span> channel<span style="color:#f92672">.</span>BasicGet<span style="color:#f92672">(</span>queueName<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
                        <span style="color:#66d9ef">if</span> ea <span style="color:#f92672">&lt;&gt;</span> <span style="color:#66d9ef">null</span> <span style="color:#66d9ef">then</span>
                            <span style="color:#66d9ef">let</span> body <span style="color:#f92672">=</span> ea<span style="color:#f92672">.</span>Body
                            <span style="color:#66d9ef">let</span> message <span style="color:#f92672">=</span> Encoding.UTF8.GetString<span style="color:#f92672">(</span>body<span style="color:#f92672">)</span>
                            message
                        <span style="color:#66d9ef">else</span>
                            <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span> 
        Publish <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>publishToQueue channel queueName<span style="color:#f92672">)}</span>
</code></pre></div><ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

  </main>
  <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://example.org/" >
    &copy;  Erich's Site 2021 
  </a>
    <div>














</div>
  </div>
</footer>

</body>

</html>